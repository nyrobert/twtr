#!/bin/bash
#
# Simple command line application for Twitter.

readonly config_file=./.config
readonly api_version="1.1"

load_config() {
  if [[ -f "${config_file}" ]] && [[ -r "${config_file}" ]]; then
    . "${config_file}"

    check_config

    readonly consumer_key
    readonly consuner_secret
    readonly access_token
    readonly access_secret
  else
    error_handler "Config file not found"
  fi
}

check_config() {
  if [[ -z "${consumer_key}" ]]; then
    error_handler "Consumer key (API key) not found"
  elif [[ -z "${consumer_secret}" ]]; then
    error_handler "Consumer secret (API secret) not found"
  elif [[ -z "${access_token}" ]]; then
    error_handler "Access token not found"
  elif [[ -z "${access_secret}" ]]; then
    error_handler "Access secret not found"
  fi
}

display_timeline() {
  declare -A request_params

  local request_params

  request_params["method"]="GET"
  request_params["url"]="https://api.twitter.com/${api_version}/statuses/home_timeline.json"
  request_params["count"]=5

  make_api_request "$(declare -p request_params)"
}

make_api_request() {
  eval "declare -A request_params=${1#*=}"

  local request_params

  # cURL call

  echo $(generate_oauth_header "$(declare -p request_params)")
}

generate_oauth_header() {
  eval "declare -A request_params=${1#*=}"

  oauth_params=$(collect_oauth_params)
  eval "declare -A oauth_params=${oauth_params#*=}"

  local i=0
  local key
  local key_encoded
  local value_encoded
  local request_params
  local oauth_params
  local oauth_params_str

  for key in "${!oauth_params[@]}"; do
    (( i++ ))

    key_encoded=$(percent_encode "${key}")
    value_encoded=$(percent_encode "${oauth_params[$key]}")
    oauth_params_str+="${key_encoded}=\"${value_encoded}\""

    if [[ "${i}" -ne "${#oauth_params[@]}" ]]; then
      oauth_params_str+=", "
    fi
  done

  echo "Authorization: OAuth ${oauth_params_str}"
  echo $(declare -p request_params)
}

collect_oauth_params() {
  declare -A params

  local params
  local signature_method="HMAC-SHA1"
  local version="1.0"

  params["oauth_consumer_key"]="${consumer_key}"
  params["oauth_nonce"]=$(generate_oauth_nonce)
  params["oauth_signature_method"]="${signature_method}"
  params["oauth_timestamp"]=$(date +%s)
  params["oauth_token"]="$access_token"
  params["oauth_version"]="${version}"

  echo $(declare -p params)
}

generate_oauth_signature() {
  local params

  eval "declare -A params=${params#*=}"
}

generate_oauth_nonce() {
  echo $(date +%s | sha256sum | base64 | head -c 32)
}

# RFC 3986, Section 2.1.
# https://gist.github.com/cdown/1163649
percent_encode() {
  local length="${#1}"

  for (( i = 0; i < length; i++ )); do
    local c="${1:i:1}"
      case "${c}" in
        [a-zA-Z0-9.~_-]) printf "$c" ;;
        *) printf '%s' "${c}" | xxd -p -c1 |
          while read c; do printf '%%%s' "${c}"; done ;;
      esac
  done
}

error_handler() {
  echo "$1" >&2
  exit 1
}

main() {
  load_config
  display_timeline
}

main
